-- [1] 사용자 테이블 (직접 구현용)
CREATE TABLE custom_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id TEXT UNIQUE NOT NULL,    -- 로그인 ID
  password TEXT NOT NULL,         -- 해싱된 비밀번호
  nickname TEXT NOT NULL,
  is_guest BOOLEAN DEFAULT FALSE, -- 게스트 여부
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- [2] 게시글 테이블
CREATE TABLE posts (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  title TEXT NOT NULL,
  content TEXT,                   -- 본문 설명
  media_type TEXT DEFAULT 'image', -- image, video, text 등
  image_url TEXT,                 -- Storage에 저장된 이미지 주소
  author_uuid UUID REFERENCES custom_users(id) ON DELETE CASCADE,
  tags TEXT[],                    -- 관련어 태그 배열
  like_count INTEGER DEFAULT 0,   -- 좋아요 총합 (랭킹용)
  view_count INTEGER DEFAULT 0    -- 조회수
);

-- [3] 좋아요 테이블 (중복 방지)
CREATE TABLE likes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_uuid UUID REFERENCES custom_users(id) ON DELETE CASCADE,
  post_id BIGINT REFERENCES posts(id) ON DELETE CASCADE,
  UNIQUE(user_uuid, post_id)
);

-- [4] 좋아요 수 자동 업데이트 트리거
CREATE OR REPLACE FUNCTION update_post_like_count()
RETURNS TRIGGER AS $$
BEGIN
  IF (TG_OP = 'INSERT') THEN
    UPDATE posts SET like_count = like_count + 1 WHERE id = NEW.post_id;
  ELSIF (TG_OP = 'DELETE') THEN
    UPDATE posts SET like_count = like_count - 1 WHERE id = OLD.post_id;
  END IF;
  RETURN NULL;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER tr_update_post_like_count
AFTER INSERT OR DELETE ON likes
FOR EACH ROW EXECUTE FUNCTION update_post_like_count();

ALTER TABLE posts ADD COLUMN source TEXT;